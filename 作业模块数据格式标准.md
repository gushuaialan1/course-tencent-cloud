# 作业模块数据格式标准

## 概述

本文档定义了酷瓜云课堂作业模块的统一数据格式标准。所有代码必须严格遵循此标准，**不允许**存在任何旧格式兼容代码。

---

## 1. 作业内容（Assignment.content）

### 数据结构
```json
{
  "questions": [
    {
      "id": "q1",
      "title": "题目标题",
      "content": "题目描述内容（可选）",
      "type": "choice|text|essay|code|file",
      "score": 10,
      "required": true,
      // 选择题特有字段
      "multiple": false,  // true=多选，false=单选
      "options": {
        "A": "选项A内容",
        "B": "选项B内容",
        "C": "选项C内容",
        "D": "选项D内容"
      },
      "correct_answer": "A",  // 单选：字符串；多选：数组 ["A", "C"]
      // 简答题特有字段
      "min_length": 10,
      "max_length": 500
    }
  ]
}
```

### 题型标准

| 题型代码 | 说明 | 是否自动评分 |
|---------|------|-------------|
| `choice` | 选择题（通过 `multiple` 字段区分单选/多选） | ✅ 是 |
| `text` | 简答题 | ❌ 否 |
| `essay` | 论述题 | ❌ 否 |
| `code` | 编程题 | ❌ 否 |
| `file` | 文件上传题 | ❌ 否 |

### 选择题详细说明

**单选题**：
```json
{
  "type": "choice",
  "multiple": false,
  "options": {"A": "选项A", "B": "选项B", "C": "选项C"},
  "correct_answer": "B"
}
```

**多选题**：
```json
{
  "type": "choice",
  "multiple": true,
  "options": {"A": "选项A", "B": "选项B", "C": "选项C", "D": "选项D"},
  "correct_answer": ["A", "C", "D"]
}
```

---

## 2. 提交内容（AssignmentSubmission.content）

### 数据结构
```json
{
  "answers": {
    "q1": "A",           // 单选题答案：字符串
    "q2": ["A", "C"],   // 多选题答案：数组
    "q3": "这是我的答案...",  // 简答题答案：字符串
    "q4": "/uploads/files/xxx.pdf"  // 文件题答案：文件路径
  }
}
```

### 答案格式规则

| 题型 | 答案格式 | 示例 |
|------|---------|------|
| 单选题 | 字符串 | `"A"` |
| 多选题 | 字符串数组 | `["A", "C"]` |
| 简答题 | 字符串 | `"这是我的答案"` |
| 论述题 | 字符串 | `"这是我的论述..."` |
| 编程题 | 字符串（代码） | `"function test() { ... }"` |
| 文件题 | 字符串（文件路径） | `"/uploads/assignment/xxx.pdf"` |

---

## 3. 批改详情（AssignmentSubmission.grade_details）

### 数据结构
```json
{
  "q1": {
    "earned_score": 10,
    "max_score": 10,
    "is_correct": true,
    "auto_graded": true,
    "feedback": "批改评语（可选）"
  },
  "q2": {
    "earned_score": 0,
    "max_score": 20,
    "is_correct": false,
    "auto_graded": true
  },
  "q3": {
    "earned_score": 15,
    "max_score": 20,
    "is_correct": false,
    "auto_graded": false,
    "feedback": "回答较好，但需要补充..."
  }
}
```

---

## 4. 数据流转标准

### 4.1 创建/编辑作业

**前端 JavaScript 提交**：
```javascript
{
  content: JSON.stringify({
    questions: [...]
  })
}
```

**后端 PHP 处理**：
```php
// 控制器层
$content = json_decode($postData['content'], true);
if (!is_array($content) || !isset($content['questions'])) {
    throw new Exception('数据格式错误');
}
$data['content'] = $content;

// 模型层
$assignment->setContentData($data['content']);
// 最终存储到数据库的 content 字段
```

### 4.2 学生提交作业

**前端 JavaScript 提交**：
```javascript
{
  content: JSON.stringify({
    answers: {
      q1: "A",
      q2: ["B", "C"],
      q3: "我的答案..."
    }
  })
}
```

**后端 PHP 处理**：
```php
// 服务层
$submissionService->submit($assignmentId, $userId, $answers);

// 内部调用
$submission->setContentData(['answers' => $answers]);
```

### 4.3 自动评分

```php
// 获取作业题目
$questions = $assignment->getQuestions();
// 返回: [['id'=>'q1', 'type'=>'choice', 'multiple'=>false, ...], ...]

// 获取学生答案
$answers = $submission->getAnswers();
// 返回: ['q1'=>'A', 'q2'=>['B','C'], ...]

// 评分
$gradingService->autoGrade($submissionId);
```

---

## 5. 废弃的字段和格式

### ❌ 禁止使用的字段名

| 废弃字段 | 替换为 |
|---------|-------|
| `question_type` | `type` |
| `question_text` | `title` |
| `question_title` | `title` |
| `question_id` | `id` |
| `single_choice` | `choice` + `multiple: false` |
| `multiple_choice` | `choice` + `multiple: true` |
| `file_upload` | `file` |
| `grade_status` | `status` |

### ❌ 禁止的数据格式

**禁止：直接存储题目数组**
```json
// ❌ 错误
[
  {"id": "q1", "title": "题目1"},
  {"id": "q2", "title": "题目2"}
]
```

**正确：必须包裹在 questions 键中**
```json
// ✅ 正确
{
  "questions": [
    {"id": "q1", "title": "题目1"},
    {"id": "q2", "title": "题目2"}
  ]
}
```

---

## 6. 代码规范

### 6.1 模型层（Models）

```php
// ❌ 禁止：兼容性代码
public function getContentData()
{
    $data = json_decode($this->content, true);
    if (is_array($data) && !isset($data['questions'])) {
        return ['questions' => $data];  // 兼容旧格式
    }
    return $data;
}

// ✅ 正确：严格验证
public function getContentData()
{
    $data = json_decode($this->content, true);
    if (!is_array($data)) {
        return ['questions' => []];
    }
    return ['questions' => $data['questions'] ?? []];
}
```

### 6.2 服务层（Services）

```php
// ✅ 正确：统一使用标准格式
$submission->setContentData(['answers' => $answers]);

// ❌ 禁止：直接传递答案数组
$submission->setContentData($answers);
```

### 6.3 前端JavaScript

```javascript
// ✅ 正确：统一格式
formData.content = JSON.stringify({
    questions: questions
});

// ❌ 禁止：直接序列化数组
formData.content = JSON.stringify(questions);
```

---

## 7. 数据验证

### 7.1 作业内容验证

```php
// AssignmentValidator
'content' => [
    'required',
    'json',
    function($value) {
        $data = json_decode($value, true);
        if (!isset($data['questions']) || !is_array($data['questions'])) {
            return '作业内容格式错误：必须包含 questions 数组';
        }
        return true;
    }
]
```

### 7.2 提交内容验证

```php
// SubmissionValidator
'content' => [
    'required',
    'json',
    function($value) {
        $data = json_decode($value, true);
        if (!isset($data['answers']) || !is_array($data['answers'])) {
            return '提交内容格式错误：必须包含 answers 对象';
        }
        return true;
    }
]
```

---

## 8. 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2025-10-16 | 初始版本，统一数据格式标准 |

---

## 9. 开发注意事项

1. **严格遵守标准**：所有新代码必须严格遵守本标准
2. **禁止兼容代码**：不允许添加任何旧格式兼容代码
3. **数据验证**：所有数据输入点必须进行格式验证
4. **错误处理**：格式不符时应抛出明确的异常
5. **文档更新**：如需调整标准，必须先更新此文档

---

## 10. 测试检查清单

创建新作业时：
- [ ] content 字段包含 `questions` 键
- [ ] 每个题目包含必需字段：`id`, `title`, `type`, `score`
- [ ] 选择题包含 `multiple`, `options`, `correct_answer` 字段
- [ ] options 是对象格式：`{"A": "...", "B": "..."}`

学生提交作业时：
- [ ] content 字段包含 `answers` 键
- [ ] 单选题答案是字符串
- [ ] 多选题答案是数组
- [ ] 所有题目ID与作业题目匹配

自动评分时：
- [ ] 选择题能正确评分
- [ ] 非选择题标记为需人工批改
- [ ] 评分结果包含所有必需字段

---

**本文档为作业模块的核心标准，所有开发人员必须严格遵守。**


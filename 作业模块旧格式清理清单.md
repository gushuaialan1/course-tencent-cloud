# 作业模块旧格式清理完整清单

## 已发现并清理的问题

### ✅ 已修复（本次提交）

1. **assignment.create.js (第541行)**
   - ❌ 旧代码：`questionData.type = 'file_upload';`
   - ✅ 新代码：`questionData.type = 'file';`

2. **grading-detail.volt (第175、193行)**
   - ❌ 旧代码：`question.type == 'choice' or question.type == 'multiple_choice'`
   - ✅ 新代码：`question.type == 'choice'`

3. **删除旧文件**
   - ❌ `SingleChoiceGrader.php` - 已删除
   - ❌ `MultipleChoiceGrader.php` - 已删除

---

## ✅ 已清理完成（grade_status 字段）

### ✅ 已修复（第二批提交）

#### 1. **app/Repos/AssignmentSubmission.php** (8处)
- ✅ 删除所有 `grade_status` 过滤条件
- ✅ `getPendingGrading()`: 改用 `status IN (submitted, auto_graded)`
- ✅ `getStatistics()`: 删除 `by_grade_status` 统计
- ✅ `assignGraders()`: 改用 `status` 更新批改状态

#### 2. **app/Http/Admin/Views/assignment/grading-list.volt** (3处)
- ✅ 筛选下拉框：`grade_status` → `status`
- ✅ 状态显示：使用 `status` 字段判断
- ✅ 重新批改按钮：`grade_status == 'completed'` → `status == 'graded'`

#### 3. **app/Http/Home/Views/assignment/result.volt** (2处)
- ✅ 批改状态提示：改用 `status` 判断
- ✅ `auto_graded`: 自动批改完成
- ✅ `grading`: 老师正在批改中
- ✅ `graded`: 批改已完成

#### 4. **app/Models/AssignmentSubmission.php**
- ✅ 删除 `$grade_status` 字段定义
- ✅ 删除 `GRADE_STATUS_*` 常量
- ✅ 删除 `getGradeStatuses()` 方法

---

## 📋 状态字段映射关系

### 旧的 grade_status（已废弃）
| 旧值 | 含义 |
|------|------|
| `pending` | 待批改 |
| `grading` | 批改中 |
| `completed` | 已完成 |

### 新的 status（统一标准）
| 新值 | 含义 |
|------|------|
| `draft` | 草稿 |
| `submitted` | 已提交（待批改） |
| `auto_graded` | 自动批改完成 |
| `grading` | 批改中 |
| `graded` | 已批改 |
| `returned` | 已退回 |

### 替换规则
| 旧代码 | 新代码 |
|--------|--------|
| `grade_status == 'pending'` | `status == 'submitted' OR status == 'auto_graded'` |
| `grade_status == 'grading'` | `status == 'grading'` |
| `grade_status == 'completed'` | `status == 'graded'` |

---

## ✅ 已确认无问题的文件

- ✅ Models/Assignment.php
- ✅ Models/AssignmentSubmission.php (除 grade_status 字段外)
- ✅ Services/Assignment/*.php
- ✅ Services/Assignment/Graders/*.php (除已删除的2个文件)
- ✅ Http/Admin/Controllers/AssignmentController.php
- ✅ Http/Admin/Controllers/AssignmentSubmissionController.php
- ✅ Http/Home/Controllers/AssignmentController.php
- ✅ Http/Home/Views/assignment/show.volt
- ✅ Validators/Assignment/QuestionValidator.php
- ✅ Validators/Assignment/AssignmentValidator.php

---

## 🎯 完成情况

1. [x] 修改 Repos/AssignmentSubmission.php，移除所有 grade_status 相关代码
2. [x] 修改 Admin/Views/assignment/grading-list.volt，使用 status 字段
3. [x] 修改 Home/Views/assignment/result.volt，使用 status 字段
4. [x] 删除 Models/AssignmentSubmission.php 中的 grade_status 字段定义
5. [x] 删除 getGradeStatuses() 方法
6. [x] 全局搜索确认无遗漏

**✅ 所有清理工作已完成！**

---

## 📌 数据库迁移说明

**⚠️ 数据库中的 grade_status 字段**：
- 数据库表 `kg_assignment_submission` 中可能仍有 `grade_status` 字段
- 虽然代码已不再使用，但数据库字段保留不影响功能
- 如需清理数据库字段，建议执行以下SQL：

```sql
-- 可选：备份数据
CREATE TABLE kg_assignment_submission_backup AS SELECT * FROM kg_assignment_submission;

-- 删除 grade_status 字段（可选）
ALTER TABLE kg_assignment_submission DROP COLUMN grade_status;
```

**注意**：删除数据库字段前，请确保：
1. 已备份数据
2. 所有代码已更新到最新版本
3. 所有服务器都已部署新代码

---

生成时间：2025-10-16
作者：系统自动生成


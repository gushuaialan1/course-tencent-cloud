# 作业模块旧格式清理完整清单

## 已发现并清理的问题

### ✅ 已修复（本次提交）

1. **assignment.create.js (第541行)**
   - ❌ 旧代码：`questionData.type = 'file_upload';`
   - ✅ 新代码：`questionData.type = 'file';`

2. **grading-detail.volt (第175、193行)**
   - ❌ 旧代码：`question.type == 'choice' or question.type == 'multiple_choice'`
   - ✅ 新代码：`question.type == 'choice'`

3. **删除旧文件**
   - ❌ `SingleChoiceGrader.php` - 已删除
   - ❌ `MultipleChoiceGrader.php` - 已删除

---

## ⚠️ 仍需清理的问题（grade_status 字段）

### 问题说明
`grade_status` 字段已被标记为 `@deprecated`，应该使用 `status` 字段替代。

### 需要修改的文件

#### 1. **app/Repos/AssignmentSubmission.php** (8处)
```php
// ❌ 需要删除的代码
if (!empty($options['grade_status'])) {
    $conditions[] = 'grade_status = :grade_status:';
    $bind['grade_status'] = $options['grade_status'];
}

// ✅ 应该改为
// 删除 grade_status 过滤相关代码
// 使用 status 字段过滤
```

#### 2. **app/Http/Admin/Views/assignment/grading-list.volt** (3处)
```volt
{# ❌ 旧代码 #}
<select name="grade_status">
{% if submission.grade_status == 'pending' %}

{# ✅ 新代码 #}
<select name="status">
{% if submission.status == 'submitted' %}
```

#### 3. **app/Http/Home/Views/assignment/result.volt** (2处)
```volt
{# ❌ 旧代码 #}
{% if submission.status == 'graded' and submission.grade_status == 'pending' %}
{% elseif submission.status == 'graded' and submission.grade_status == 'completed' %}

{# ✅ 新代码 #}
{% if submission.status == 'grading' %}
{% elseif submission.status == 'graded' %}
```

#### 4. **app/Models/AssignmentSubmission.php**
```php
// ❌ 删除字段定义
public $grade_status = null;

// ❌ 删除方法
public static function getGradeStatuses()
```

---

## 📋 状态字段映射关系

### 旧的 grade_status（已废弃）
| 旧值 | 含义 |
|------|------|
| `pending` | 待批改 |
| `grading` | 批改中 |
| `completed` | 已完成 |

### 新的 status（统一标准）
| 新值 | 含义 |
|------|------|
| `draft` | 草稿 |
| `submitted` | 已提交（待批改） |
| `auto_graded` | 自动批改完成 |
| `grading` | 批改中 |
| `graded` | 已批改 |
| `returned` | 已退回 |

### 替换规则
| 旧代码 | 新代码 |
|--------|--------|
| `grade_status == 'pending'` | `status == 'submitted' OR status == 'auto_graded'` |
| `grade_status == 'grading'` | `status == 'grading'` |
| `grade_status == 'completed'` | `status == 'graded'` |

---

## ✅ 已确认无问题的文件

- ✅ Models/Assignment.php
- ✅ Models/AssignmentSubmission.php (除 grade_status 字段外)
- ✅ Services/Assignment/*.php
- ✅ Services/Assignment/Graders/*.php (除已删除的2个文件)
- ✅ Http/Admin/Controllers/AssignmentController.php
- ✅ Http/Admin/Controllers/AssignmentSubmissionController.php
- ✅ Http/Home/Controllers/AssignmentController.php
- ✅ Http/Home/Views/assignment/show.volt
- ✅ Validators/Assignment/QuestionValidator.php
- ✅ Validators/Assignment/AssignmentValidator.php

---

## 🎯 下一步行动

1. [ ] 修改 Repos/AssignmentSubmission.php，移除所有 grade_status 相关代码
2. [ ] 修改 Admin/Views/assignment/grading-list.volt，使用 status 字段
3. [ ] 修改 Home/Views/assignment/result.volt，使用 status 字段
4. [ ] 删除 Models/AssignmentSubmission.php 中的 grade_status 字段定义
5. [ ] 删除 getGradeStatuses() 方法
6. [ ] 全局搜索确认无遗漏

---

## 📌 注意事项

**grade_status 字段清理属于 BREAKING CHANGE**：
- 数据库中可能仍有 grade_status 字段数据
- 需要数据迁移脚本将旧数据转换为新的 status 值
- 清理后旧数据无法正常显示，必须先迁移

**建议**：
1. 先运行数据迁移脚本（如果有）
2. 再清理代码中的 grade_status 引用
3. 最后删除数据库表中的 grade_status 字段

---

生成时间：2025-10-16
作者：系统自动生成


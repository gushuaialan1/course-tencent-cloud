-- =====================================================
-- 最终修复：更新管理员角色权限（包含完整的知识图谱和作业权限）
-- 执行此脚本前请确保已上传最新的 AuthNode.php
-- =====================================================

-- 查看当前权限
SELECT id, name, JSON_LENGTH(routes) as '当前权限数量' FROM kg_role WHERE id = 1;

-- 更新为完整权限（包含所有新增功能的完整路由）
UPDATE kg_role 
SET routes = '["admin.course.list","admin.course.search","admin.course.add","admin.course.edit","admin.course.delete","admin.course.show","admin.course.create","admin.course.update","admin.course.restore","admin.course.batch_delete","admin.course.moderate","admin.course.category","admin.course.chapters","admin.course.resources","admin.package.list","admin.package.search","admin.package.add","admin.package.edit","admin.package.delete","admin.package.show","admin.package.create","admin.package.update","admin.package.restore","admin.package.batch_delete","admin.topic.list","admin.topic.search","admin.topic.add","admin.topic.edit","admin.topic.delete","admin.topic.show","admin.topic.create","admin.topic.update","admin.topic.restore","admin.topic.batch_delete","admin.article.list","admin.article.search","admin.article.add","admin.article.edit","admin.article.delete","admin.article.show","admin.article.create","admin.article.update","admin.article.restore","admin.article.moderate","admin.article.report","admin.article.batch_delete","admin.article.batch_moderate","admin.article.category","admin.question.list","admin.question.search","admin.question.add","admin.question.edit","admin.question.delete","admin.question.show","admin.question.create","admin.question.update","admin.question.restore","admin.question.moderate","admin.question.report","admin.question.batch_delete","admin.question.batch_moderate","admin.question.category","admin.answer.list","admin.answer.search","admin.answer.add","admin.answer.edit","admin.answer.delete","admin.answer.show","admin.answer.create","admin.answer.update","admin.answer.restore","admin.answer.moderate","admin.answer.report","admin.answer.batch_delete","admin.answer.batch_moderate","admin.comment.list","admin.comment.search","admin.comment.edit","admin.comment.delete","admin.comment.update","admin.comment.restore","admin.comment.moderate","admin.comment.report","admin.comment.batch_delete","admin.comment.batch_moderate","admin.nav.list","admin.nav.add","admin.nav.edit","admin.nav.delete","admin.nav.create","admin.nav.update","admin.nav.restore","admin.page.list","admin.page.add","admin.page.edit","admin.page.delete","admin.page.create","admin.page.update","admin.page.restore","admin.help.list","admin.help.add","admin.help.edit","admin.help.delete","admin.help.create","admin.help.update","admin.help.restore","admin.help.category","admin.tag.list","admin.tag.search","admin.tag.add","admin.tag.edit","admin.tag.delete","admin.tag.create","admin.tag.update","admin.tag.restore","admin.category.list","admin.category.add","admin.category.edit","admin.category.delete","admin.category.create","admin.category.update","admin.category.restore","admin.chapter.add","admin.chapter.edit","admin.chapter.delete","admin.chapter.create","admin.chapter.update","admin.chapter.content","admin.chapter.restore","admin.chapter.lessons","admin.knowledge_graph.list","admin.knowledge_graph.editor","admin.knowledge_graph.nodes","admin.knowledge_graph.node_create","admin.knowledge_graph.node_edit","admin.knowledge_graph.create_node","admin.knowledge_graph.update_node","admin.knowledge_graph.delete_node","admin.knowledge_graph.create_relation","admin.knowledge_graph.update_relation","admin.knowledge_graph.delete_relation","admin.knowledge_graph.data","admin.knowledge_graph.save","admin.knowledge_graph.analysis","admin.knowledge_graph.export","admin.knowledge_graph.templates","admin.knowledge_graph.template_detail","admin.knowledge_graph.apply_template","admin.knowledge_graph.template_create","admin.knowledge_graph.template_update","admin.knowledge_graph.template_delete","admin.assignment.list","admin.assignment.create","admin.assignment.do_create","admin.assignment.search","admin.assignment.stats","admin.assignment.edit","admin.assignment.update","admin.assignment.show","admin.assignment.delete","admin.assignment.publish","admin.assignment.close","admin.assignment.duplicate","admin.assignment.batch","admin.assignment.grading.list","admin.assignment.submission.detail","admin.assignment.submission.grade","admin.assignment.grading.batch","admin.stat.hot_sales","admin.stat.sales","admin.stat.refunds","admin.stat.reg_users","admin.stat.online_users","admin.vip.list","admin.vip.add","admin.vip.edit","admin.vip.delete","admin.vip.create","admin.vip.update","admin.vip.restore","admin.point_gift.list","admin.point_gift.add","admin.point_gift.edit","admin.point_gift.delete","admin.point_gift.create","admin.point_gift.update","admin.point_gift.restore","admin.point_gift_redeem.list","admin.point_history.list","admin.consult.list","admin.consult.search","admin.consult.edit","admin.consult.delete","admin.consult.update","admin.consult.restore","admin.consult.moderate","admin.consult.batch_moderate","admin.review.list","admin.review.search","admin.review.edit","admin.review.delete","admin.review.update","admin.review.restore","admin.review.moderate","admin.review.batch_moderate","admin.slide.list","admin.slide.search","admin.slide.add","admin.slide.edit","admin.slide.delete","admin.slide.create","admin.slide.update","admin.slide.restore","admin.mod.reviews","admin.mod.consults","admin.mod.articles","admin.mod.questions","admin.mod.answers","admin.mod.comments","admin.report.articles","admin.report.questions","admin.report.answers","admin.report.comments","admin.order.list","admin.order.search","admin.order.show","admin.order.status_history","admin.trade.list","admin.trade.search","admin.trade.show","admin.trade.refund","admin.trade.status_history","admin.refund.list","admin.refund.search","admin.refund.show","admin.refund.review","admin.refund.status_history","admin.user.list","admin.user.search","admin.user.add","admin.user.edit","admin.user.create","admin.user.update","admin.user.online","admin.role.list","admin.role.add","admin.role.edit","admin.role.delete","admin.role.create","admin.role.update","admin.role.restore","admin.audit.list","admin.audit.search","admin.audit.show","admin.setting.site","admin.setting.contact","admin.setting.oauth","admin.setting.mail","admin.setting.pay","admin.setting.secret","admin.setting.sms","admin.setting.storage","admin.setting.vod","admin.setting.live","admin.setting.point","admin.setting.wechat_oa","admin.setting.dingtalk_robot","admin.util.index_cache","admin.resource.upload_enhanced","admin.resource.recent","admin.resource.batch_upload","admin.resource.preview","admin.resource.create","admin.resource.update","admin.resource.delete","admin.resource.restore"]',
update_time = UNIX_TIMESTAMP()
WHERE id = 1;

-- 查看更新后的权限数量
SELECT 
    id, 
    name, 
    JSON_LENGTH(routes) as '更新后权限数量',
    FROM_UNIXTIME(update_time) as '更新时间'
FROM kg_role 
WHERE id = 1;

-- 验证关键权限是否存在
SELECT 
    CASE WHEN JSON_CONTAINS(routes, '"admin.knowledge_graph.list"') THEN '✓' ELSE '✗' END as '知识图谱列表',
    CASE WHEN JSON_CONTAINS(routes, '"admin.knowledge_graph.editor"') THEN '✓' ELSE '✗' END as '图谱编辑器',
    CASE WHEN JSON_CONTAINS(routes, '"admin.knowledge_graph.nodes"') THEN '✓' ELSE '✗' END as '节点管理',
    CASE WHEN JSON_CONTAINS(routes, '"admin.assignment.list"') THEN '✓' ELSE '✗' END as '作业列表',
    CASE WHEN JSON_CONTAINS(routes, '"admin.assignment.grading.list"') THEN '✓' ELSE '✗' END as '评分列表',
    CASE WHEN JSON_CONTAINS(routes, '"admin.course.list"') THEN '✓' ELSE '✗' END as '课程管理',
    CASE WHEN JSON_CONTAINS(routes, '"admin.setting.site"') THEN '✓' ELSE '✗' END as '系统设置'
FROM kg_role 
WHERE id = 1;


# 管理员角色权限更新说明

## 问题描述
管理员无法访问新添加的功能（知识图谱、作业系统等），因为这些权限没有包含在管理员角色的默认权限中。

## 解决方案

提供了3种更新方法，**任选一种**即可：

---

## 方法1：执行数据库迁移脚本（推荐）

### 步骤：

1. **上传迁移文件到服务器**
   ```bash
   # 将以下文件上传到服务器
   course-tencent-cloud/db/migrations/20241005000001_update_admin_role_permissions.php
   ```

2. **SSH连接服务器，执行迁移**
   ```bash
   cd /www/wwwroot/你的项目路径/course-tencent-cloud
   php console.php migration:run
   ```

3. **查看执行结果**
   应该看到类似输出：
   ```
   ✓ 已为管理员角色添加 37 个新权限
   ✓ 管理员角色现在共有 XXX 个权限
   ```

---

## 方法2：使用SQL脚本（简单直接）

### 宝塔面板操作：

1. **打开数据库管理**
   - 登录宝塔面板
   - 点击左侧菜单"数据库"
   - 找到你的项目数据库，点击"管理"
   - 点击顶部的"SQL"标签

2. **执行SQL**
   - 打开 `update_admin_permissions.sql` 文件
   - 复制全部内容
   - 粘贴到SQL窗口
   - 点击"执行"按钮

3. **确认结果**
   在SQL窗口底部应该看到：
   ```
   权限数量: 200+
   更新时间: 2025-10-05 XX:XX:XX
   ```

### 命令行操作：

```bash
# 上传 update_admin_permissions.sql 到服务器

# 执行SQL文件
mysql -u数据库用户名 -p数据库名 < update_admin_permissions.sql

# 输入数据库密码后执行
```

---

## 方法3：手动SQL更新（最快）

如果上面两种方法不方便，直接在数据库管理工具中执行以下SQL：

```sql
-- 查看当前权限数量
SELECT id, name, JSON_LENGTH(routes) as permission_count 
FROM kg_role WHERE id = 1;

-- 在原有权限基础上，追加新权限
UPDATE kg_role 
SET routes = JSON_MERGE_PRESERVE(
    routes,
    JSON_ARRAY(
        'admin.knowledge_graph.list',
        'admin.knowledge_graph.editor',
        'admin.knowledge_graph.nodes',
        'admin.knowledge_graph.create_node',
        'admin.knowledge_graph.update_node',
        'admin.knowledge_graph.delete_node',
        'admin.knowledge_graph.create_relation',
        'admin.knowledge_graph.update_relation',
        'admin.knowledge_graph.delete_relation',
        'admin.knowledge_graph.data',
        'admin.knowledge_graph.save',
        'admin.knowledge_graph.analysis',
        'admin.knowledge_graph.export',
        'admin.knowledge_graph.templates',
        'admin.knowledge_graph.template_detail',
        'admin.knowledge_graph.apply_template',
        'admin.knowledge_graph.template_create',
        'admin.knowledge_graph.template_update',
        'admin.knowledge_graph.template_delete',
        'admin.assignment.list',
        'admin.assignment.create',
        'admin.assignment.search',
        'admin.assignment.stats',
        'admin.assignment.edit',
        'admin.assignment.show',
        'admin.assignment.store',
        'admin.assignment.update',
        'admin.assignment.delete',
        'admin.assignment.restore',
        'admin.assignment.publish',
        'admin.assignment.close',
        'admin.assignment_submission.list',
        'admin.assignment_submission.detail',
        'admin.assignment_submission.review',
        'admin.assignment_submission.update_score',
        'admin.assignment_submission.batch_review',
        'admin.resource.upload_enhanced',
        'admin.resource.recent'
    )
),
update_time = UNIX_TIMESTAMP()
WHERE id = 1;

-- 确认更新成功
SELECT id, name, JSON_LENGTH(routes) as permission_count 
FROM kg_role WHERE id = 1;
```

---

## 验证更新是否成功

1. **退出后台管理**
2. **重新登录**
3. **访问知识图谱页面**
   ```
   http://你的域名/admin/knowledge-graph/list
   ```
4. 应该能正常看到知识图谱列表页面，不再出现403错误

---

## 注意事项

1. **备份数据库**
   执行任何数据库操作前，建议先备份数据库
   ```bash
   # 宝塔面板：数据库 -> 点击数据库名 -> 备份
   ```

2. **清除缓存**
   更新权限后，建议清除应用缓存：
   ```bash
   cd /www/wwwroot/你的项目路径/course-tencent-cloud
   rm -rf storage/cache/*
   ```

3. **重新登录**
   权限更新后必须重新登录才能生效

---

## 包含的新权限

### 知识图谱模块（21个权限）
- 图谱列表、编辑器、节点管理
- 节点增删改查
- 关系增删改查
- 图谱分析、导出
- 模板管理

### 作业系统模块（16个权限）
- 作业列表、创建、编辑、删除
- 作业统计、搜索
- 提交列表、详情、评审
- 批量评审、评分

### 资源管理增强（2个权限）
- 增强上传
- 最近文件

**共计：39个新权限**

---

## 常见问题

### Q1: 执行后还是无法访问？
**A:** 确保已退出并重新登录，权限信息缓存在session中

### Q2: 如何确认权限已更新？
**A:** 在数据库中执行：
```sql
SELECT JSON_LENGTH(routes) FROM kg_role WHERE id = 1;
```
结果应该 > 200

### Q3: 其他角色也需要这些权限吗？
**A:** 其他角色（运营、编辑、财务）可以根据需要在后台界面手动分配权限

---

## 更新时间
2025-10-05

## 作者
AI助手


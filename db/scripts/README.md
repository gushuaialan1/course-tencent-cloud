# æ•°æ®åº“è¿ç§»ä¸å¤‡ä»½è„šæœ¬ä½¿ç”¨æŒ‡å—

## ğŸ“‹ è„šæœ¬æ¸…å•

| è„šæœ¬æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|---------|---------|
| `backup_database.sh` | å¤‡ä»½æ•°æ®åº“ |
| `restore_database.sh` | æ¢å¤æ•°æ®åº“ |
| `run_assignment_migrations.sh` | æ‰§è¡Œä½œä¸šæ¨¡å—æ•°æ®è¿ç§» |
| `check_migration_status.sh` | æ£€æŸ¥è¿ç§»çŠ¶æ€ |

---

## ğŸ—„ï¸ æ•°æ®åº“é…ç½®

å½“å‰é…ç½®ï¼ˆä» `config/config.php` è¯»å–ï¼‰ï¼š

```
ä¸»æœº: localhost
ç«¯å£: 3306
æ•°æ®åº“: kugua_mooc
ç”¨æˆ·å: kugua_user
å¯†ç : 67GEyZ56k2n6HwsB
å­—ç¬¦é›†: utf8mb4
```

---

## ğŸ“– ä½¿ç”¨è¯´æ˜

### 1ï¸âƒ£ å¤‡ä»½æ•°æ®åº“

```bash
cd /path/to/course-tencent-cloud/db/scripts
bash backup_database.sh
```

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨å¤‡ä»½å®Œæ•´æ•°æ®åº“
- å‹ç¼©ä¸º `.gz` æ ¼å¼èŠ‚çœç©ºé—´
- è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„æ—§å¤‡ä»½

**å¤‡ä»½ä½ç½®**ï¼š`storage/backup/kugua_mooc_backup_YYYYMMDD_HHMMSS.sql.gz`

---

### 2ï¸âƒ£ æ£€æŸ¥è¿ç§»çŠ¶æ€

åœ¨æ‰§è¡Œè¿ç§»å‰ï¼Œå…ˆæ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€ï¼š

```bash
cd /path/to/course-tencent-cloud/db/scripts
bash check_migration_status.sh
```

**è¾“å‡ºä¿¡æ¯**ï¼š
- ä½œä¸šæ€»æ•° + æ–°æ—§æ ¼å¼åˆ†å¸ƒ
- æäº¤æ€»æ•° + æ–°æ—§æ ¼å¼åˆ†å¸ƒ
- çŠ¶æ€å­—æ®µä½¿ç”¨æƒ…å†µ
- è¯„åˆ†è¯¦æƒ…æ ¼å¼

---

### 3ï¸âƒ£ æ‰§è¡Œä½œä¸šæ¨¡å—è¿ç§»

âš ï¸ **æ‰§è¡Œå‰å¿…è¯»**ï¼š
- å¿…é¡»å…ˆæ‰§è¡Œå¤‡ä»½ï¼
- å»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œ
- æ•´ä¸ªè¿‡ç¨‹éœ€è¦3-10åˆ†é’Ÿï¼ˆå–å†³äºæ•°æ®é‡ï¼‰

```bash
cd /path/to/course-tencent-cloud/db/scripts
bash run_assignment_migrations.sh
```

**æ‰§è¡Œæµç¨‹**ï¼š

```
æ­¥éª¤ 1/5: å¤‡ä»½æ•°æ®åº“
         â†“
æ­¥éª¤ 2/5: æ£€æŸ¥å½“å‰æ•°æ®ï¼ˆæ˜¾ç¤ºç»Ÿè®¡ï¼‰
         â†“
æ­¥éª¤ 3/5: è¿ç§»ä½œä¸šé¢˜ç›®æ ¼å¼ (questions)
         â†“
æ­¥éª¤ 4/5: è¿ç§»å­¦ç”Ÿç­”æ¡ˆæ ¼å¼ (answers)
         â†“
æ­¥éª¤ 5/5: è¿ç§»æäº¤çŠ¶æ€å­—æ®µ (status)
         â†“
       éªŒè¯ç»“æœ
```

**è¿ç§»å†…å®¹**ï¼š

| è¿ç§»é¡¹ | æ—§æ ¼å¼ | æ–°æ ¼å¼ |
|-------|-------|-------|
| ä½œä¸šé¢˜ç›® | `content: [{...}, {...}]` | `content: {questions: [{...}]}` |
| å­¦ç”Ÿç­”æ¡ˆ | `content: {"q1": "A", ...}` | `content: {answers: {"q1": "A"}}` |
| æäº¤çŠ¶æ€ | `status + grade_status` | ç®€åŒ–ä¸ºå•ä¸ª `status` |
| è¯„åˆ†è¯¦æƒ… | è‡ªç”±æ ¼å¼ | `{grading: {...}, summary: {...}}` |

---

### 4ï¸âƒ£ æ¢å¤æ•°æ®åº“ï¼ˆå›æ»šï¼‰

å¦‚æœè¿ç§»å¤±è´¥æˆ–éœ€è¦å›æ»šï¼š

```bash
cd /path/to/course-tencent-cloud/db/scripts

# æŸ¥çœ‹å¯ç”¨å¤‡ä»½
bash restore_database.sh

# æ¢å¤æŒ‡å®šå¤‡ä»½
bash restore_database.sh /path/to/backup_file.sql.gz
```

**ç¤ºä¾‹**ï¼š
```bash
bash restore_database.sh ../../storage/backup/kugua_mooc_backup_20250115_120000.sql.gz
```

---

## âš¡ å¿«é€Ÿä¸Šæ‰‹ï¼ˆå®Œæ•´æµç¨‹ï¼‰

```bash
# 1. è¿›å…¥è„šæœ¬ç›®å½•
cd /path/to/course-tencent-cloud/db/scripts

# 2. æ£€æŸ¥å½“å‰çŠ¶æ€
bash check_migration_status.sh

# 3. æ‰§è¡Œè¿ç§»ï¼ˆåŒ…å«è‡ªåŠ¨å¤‡ä»½ï¼‰
bash run_assignment_migrations.sh

# 4. å†æ¬¡æ£€æŸ¥ç¡®è®¤
bash check_migration_status.sh
```

---

## ğŸ›¡ï¸ å®‰å…¨å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒè¿ç§»å‰**ï¼š
   - âœ… åœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´éªŒè¯
   - âœ… é€‰æ‹©ä½å³°æœŸï¼ˆå‡Œæ™¨2-6ç‚¹ï¼‰
   - âœ… é€šçŸ¥ç”¨æˆ·ç»´æŠ¤æ—¶é—´
   - âœ… å‡†å¤‡å›æ»šé¢„æ¡ˆ

2. **å¤‡ä»½ç­–ç•¥**ï¼š
   - âœ… è¿ç§»å‰æ‰‹åŠ¨å¤‡ä»½
   - âœ… ä¿ç•™è‡³å°‘3å¤©çš„å¤‡ä»½
   - âœ… æµ‹è¯•å¤‡ä»½æ¢å¤æµç¨‹

3. **æƒé™æ£€æŸ¥**ï¼š
   ```bash
   # ç¡®ä¿MySQLç”¨æˆ·æœ‰è¶³å¤Ÿæƒé™
   mysql -h localhost -u kugua_user -p67GEyZ56k2n6HwsB -e "SHOW GRANTS;"
   ```

---

## ğŸ“Š è¿ç§»é¢„è®¡æ—¶é—´

| æ•°æ®é‡ | é¢„è®¡è€—æ—¶ |
|-------|---------|
| < 100æ¡ä½œä¸š | 1-2åˆ†é’Ÿ |
| 100-1000æ¡ä½œä¸š | 3-5åˆ†é’Ÿ |
| > 1000æ¡ä½œä¸š | 5-10åˆ†é’Ÿ |

---

## â“ å¸¸è§é—®é¢˜

### Q1: è¿ç§»å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
```bash
# ç«‹å³æ¢å¤å¤‡ä»½
bash restore_database.sh [æœ€æ–°å¤‡ä»½æ–‡ä»¶]
```

### Q2: å¦‚ä½•åªè¿ç§»éƒ¨åˆ†æ•°æ®ï¼Ÿ
```bash
# ç¼–è¾‘è¿ç§»PHPæ–‡ä»¶ï¼Œæ·»åŠ WHEREæ¡ä»¶
# ä¾‹å¦‚ï¼šWHERE id > 100 AND id < 200
```

### Q3: è¿ç§»åæ—§ä»£ç è¿˜èƒ½ç”¨å—ï¼Ÿ
**éƒ¨åˆ†å…¼å®¹**ï¼š
- âœ… è¯»å–æ“ä½œå‘åå…¼å®¹ï¼ˆModelå±‚å·²å¤„ç†ï¼‰
- âš ï¸  ç›´æ¥å†™å…¥æ—§æ ¼å¼ä¼šå¯¼è‡´éªŒè¯å¤±è´¥
- å»ºè®®ï¼šè¿ç§»åä½¿ç”¨æ–°Serviceå±‚

### Q4: å¦‚ä½•éªŒè¯è¿ç§»ç»“æœï¼Ÿ
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨æ£€æŸ¥è„šæœ¬
bash check_migration_status.sh

# æ–¹æ³•2ï¼šæ‰‹åŠ¨æŸ¥è¯¢
mysql -h localhost -u kugua_user -p -D kugua_mooc -e "
    SELECT id, title, 
           JSON_EXTRACT(content, '$.questions[0].title') as first_question
    FROM kg_assignment 
    LIMIT 3;
"
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### é”™è¯¯1: è¿æ¥æ•°æ®åº“å¤±è´¥
```
ERROR 1045 (28000): Access denied
```
**è§£å†³**ï¼šæ£€æŸ¥ `config/config.php` ä¸­çš„æ•°æ®åº“å¯†ç 

### é”™è¯¯2: JSONæ ¼å¼æ— æ•ˆ
```
Invalid JSON in content field
```
**è§£å†³**ï¼šæŸ¥çœ‹è¿ç§»æ—¥å¿—ï¼Œæ‰¾åˆ°é—®é¢˜è®°å½•çš„IDï¼Œæ‰‹åŠ¨ä¿®å¤

### é”™è¯¯3: æƒé™ä¸è¶³
```
ERROR 1227 (42000): Access denied; you need SUPER privilege
```
**è§£å†³**ï¼šä½¿ç”¨rootç”¨æˆ·æ‰§è¡Œæˆ–æˆäºˆç›¸åº”æƒé™

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. é”™è¯¯æ—¥å¿—æˆªå›¾
2. `check_migration_status.sh` çš„è¾“å‡º
3. æ•°æ®é‡ç»Ÿè®¡ï¼ˆä½œä¸šæ•°ã€æäº¤æ•°ï¼‰

---

**æœ€åæ›´æ–°**: 2025-01-15  
**é€‚ç”¨ç‰ˆæœ¬**: ä½œä¸šæ¨¡å—é‡æ„ v2.0


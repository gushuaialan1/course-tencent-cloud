# 作业模块前后台数据规范对照表

**创建时间**: 2025-10-15  
**规范版本**: v1.0

---

## 1. 字段命名规范对照表

### 1.1 Assignment（作业表）字段

| 数据库字段 | PHP访问 | JavaScript访问 | Volt模板访问 | 数据类型 | 说明 | ❌废弃字段 |
|-----------|---------|---------------|-------------|---------|------|----------|
| `max_score` | `$assignment->max_score` | `assignment.max_score` | `assignment.max_score` | decimal(10,2) | 作业总分 | ~~`total_score`~~ |
| `due_date` | `$assignment->due_date` | `assignment.due_date` | `assignment.due_date` | int(11) | 截止时间(Unix时间戳) | ~~`deadline`~~ |
| `allow_late` | `$assignment->allow_late` | `assignment.allow_late` | `assignment.allow_late` | tinyint(1) | 是否允许迟交(0/1) | ~~`allow_resubmit`~~ |
| `content` | `$assignment->getContentData()` | `assignment.content` | `assignment.content` | text(JSON) | 作业题目内容 | ~~`questions`~~ |
| `grade_mode` | `$assignment->grade_mode` | `assignment.grade_mode` | `assignment.grade_mode` | varchar(20) | 评分模式 | - |
| `rubric` | `$assignment->getRubricData()` | `assignment.rubric` | `assignment.rubric` | text(JSON) | 评分标准 | - |
| `attachments` | `$assignment->getAttachmentsData()` | `assignment.attachments` | `assignment.attachments` | text(JSON) | 附件列表 | - |

### 1.2 AssignmentSubmission（作业提交表）字段

| 数据库字段 | PHP访问 | JavaScript访问 | Volt模板访问 | 数据类型 | 说明 | ❌废弃字段 |
|-----------|---------|---------------|-------------|---------|------|----------|
| `content` | `$submission->getContentData()` | `submission.content` | `submission.content` | text(JSON) | 学生答案 | ~~`answers`~~ |
| `submit_time` | `$submission->submit_time` | `submission.submit_time` | `submission.submit_time` | int(11) | 提交时间 | ~~`submitted_at`~~ |
| `grade_time` | `$submission->grade_time` | `submission.grade_time` | `submission.grade_time` | int(11) | 批改时间 | ~~`graded_at`~~ |
| `grader_id` | `$submission->grader_id` | `submission.grader_id` | `submission.grader_id` | int(11) NULL | 批改人ID | - |
| `status` | `$submission->status` | `submission.status` | `submission.status` | varchar(20) | 提交状态 | - |
| `grade_status` | `$submission->grade_status` | `submission.grade_status` | `submission.grade_status` | varchar(20) | 批改状态 | - |
| `delete_time` | `$submission->delete_time` | `submission.delete_time` | `submission.delete_time` | int(11) | 删除时间(软删除) | ~~`deleted`~~ |

---

## 2. 题目数据结构规范

### 2.1 Assignment.content 结构（题目数组）

**标准格式**（直接数组）：
```json
[
  {
    "id": 1,
    "type": "choice",
    "title": "题目标题",
    "score": 40,
    "multiple": false,
    "options": {
      "A": "选项A内容",
      "B": "选项B内容",
      "C": "选项C内容",
      "D": "选项D内容"
    },
    "correct_answer": "A"
  },
  {
    "id": 2,
    "type": "choice",
    "title": "多选题示例",
    "score": 30,
    "multiple": true,
    "options": {
      "A": "选项A",
      "B": "选项B",
      "C": "选项C"
    },
    "correct_answer": ["A", "C"]
  },
  {
    "id": 3,
    "type": "essay",
    "title": "简答题示例",
    "score": 30,
    "min_length": 50,
    "max_length": 500
  }
]
```

**兼容格式**（旧版包裹在questions键中）：
```json
{
  "questions": [
    { "id": 1, "type": "choice", ... }
  ]
}
```

### 2.2 题目类型（type）枚举值

| 类型值 | 说明 | 是否自动评分 | 前端组件类型 |
|-------|------|------------|------------|
| `choice` | 选择题（单选/多选，通过multiple字段区分） | ✅ 是 | radio/checkbox |
| `essay` | 简答题/文本题 | ❌ 否 | textarea |
| `code` | 编程题 | ❌ 否 | code editor |
| `file_upload` | 文件上传题 | ❌ 否 | file input |

⚠️ **重要**：前端不得使用自定义类型名如`radio`, `checkbox`, `text`等。

### 2.3 题目字段详细说明

| 字段名 | 数据类型 | 必填 | 说明 | 示例 |
|-------|---------|------|------|------|
| `id` | int/string | ✅ | 题目ID（唯一标识） | `1` |
| `type` | string | ✅ | 题目类型 | `"choice"` |
| `title` | string | ✅ | 题目标题 | `"以下哪个是PHP框架？"` |
| `score` | number | ✅ | 题目分值 | `40` |
| `multiple` | boolean | 当type=choice时必填 | 是否多选 | `false` |
| `options` | object | 当type=choice时必填 | 选项（对象格式） | `{"A": "Laravel", "B": "Django"}` |
| `correct_answer` | string/array | 选择题必填 | 正确答案 | 单选：`"A"` 多选：`["A", "C"]` |
| `required` | boolean | ❌ | 是否必答 | `true` |
| `min_length` | int | ❌ | 最小字数（简答题） | `50` |
| `max_length` | int | ❌ | 最大字数（简答题） | `500` |

---

## 3. 学生答案数据结构规范

### 3.1 AssignmentSubmission.content 结构

**标准格式**（题目ID → 答案值）：
```json
{
  "1": "A",
  "2": ["A", "C"],
  "3": "这是学生的简答题答案内容..."
}
```

### 3.2 不同题型的答案格式规范

| 题目类型 | 答案数据类型 | 格式示例 | ✅正确 | ❌错误 |
|---------|------------|---------|-------|-------|
| 单选题 (choice + multiple=false) | **字符串** | `"A"` | `{"1": "A"}` | `{"1": ["A"]}` |
| 多选题 (choice + multiple=true) | **数组** | `["A", "C"]` | `{"2": ["A", "C"]}` | `{"2": "A,C"}` |
| 简答题 (essay) | **字符串** | `"学生答案..."` | `{"3": "..."}` | `{"3": null}` |
| 编程题 (code) | **字符串** | `"<?php ..."` | `{"4": "..."}` | - |
| 文件上传 (file_upload) | **字符串**（文件路径） | `"/uploads/xxx.pdf"` | `{"5": "/uploads/..."}` | - |

⚠️ **关键规则**：
1. **单选题答案必须是字符串**，即使只有一个选项也不能用数组
2. **多选题答案必须是数组**，即使只选了一个选项也必须用数组包裹
3. **题目ID作为key时统一使用字符串**：`{"1": "A"}` 而不是 `{1: "A"}`

---

## 4. 自动评分规则

### 4.1 可自动评分的题型

| 题型 | 是否自动评分 | 评分算法 |
|------|------------|---------|
| 单选题 | ✅ 是 | 字符串严格相等比较 |
| 多选题 | ✅ 是 | 数组完全匹配（排序后比较）|
| 简答题 | ❌ 否 | 必须人工批改 |
| 编程题 | ❌ 否 | 必须人工批改 |
| 文件上传题 | ❌ 否 | 必须人工批改 |

### 4.2 单选题评分算法

```php
// 学生答案类型：字符串（如 "A"）
// 正确答案类型：字符串（如 "A"）
$userAnswer = "A"; // 字符串
$correctAnswer = "A"; // 字符串

if ($userAnswer === $correctAnswer) {
    $score = $question['score']; // 得满分
} else {
    $score = 0;
}
```

### 4.3 多选题评分算法

```php
// 学生答案类型：数组（如 ["A", "C"]）
// 正确答案类型：数组（如 ["A", "C"]）
$userAnswer = ["A", "C"]; // 数组
$correctAnswer = ["A", "C"]; // 数组

// 排序后比较（顺序无关）
sort($userAnswer);
sort($correctAnswer);

if ($userAnswer === $correctAnswer) {
    $score = $question['score']; // 得满分
} else {
    $score = 0; // 不支持部分得分
}
```

⚠️ **注意**：多选题不支持部分得分，必须全部选对才得分。

---

## 5. 提交状态管理规范

### 5.1 状态字段组合

AssignmentSubmission 使用两个字段管理状态：

| status | grade_status | 含义 | 前端显示 | 操作按钮 |
|--------|-------------|------|---------|---------|
| `draft` | `pending` | 草稿 | "草稿" | "继续编辑" |
| `submitted` | `pending` | 已提交，等待批改 | "已提交" | "等待批改" |
| `graded` | `pending` | 批改中（mixed模式，部分批改） | "批改中" | 显示已批改部分分数 |
| `graded` | `completed` | 已批改完成 | "已批改" | "查看成绩" |
| `returned` | `completed` | 已退回 | "已退回" | "重新提交" |

### 5.2 批改模式与grader_id设置

| grade_mode | 批改方式 | grader_id | grade_status（提交后） | 说明 |
|-----------|---------|-----------|---------------------|------|
| `auto` | 纯自动批改 | `NULL` ⚠️ | `completed` | 提交即完成批改 |
| `manual` | 纯手动批改 | `assignment.owner_id` | `pending` | 等待教师批改 |
| `mixed` | 混合批改 | `assignment.owner_id` | `pending` | 选择题已自动评分，主观题等待批改 |

⚠️ **重要**：`auto`模式下`grader_id`必须为`NULL`，不能为`0`，否则触发外键约束错误。

---

## 6. 前端数据传递规范

### 6.1 日期时间格式转换

| 场景 | 前端输入 | 转换后 | 后端存储 |
|------|---------|-------|---------|
| 提交截止时间 | `"2025-10-20 23:59:00"` | `Math.floor(new Date(dateStr).getTime() / 1000)` | `1729440000` (Unix时间戳) |
| 发布时间 | `"2025-10-15 10:00:00"` | 同上 | Unix时间戳 |

### 6.2 复选框值转换

| 字段 | 前端勾选 | 前端未勾选 | 后端接收 |
|------|---------|-----------|---------|
| `allow_late` | `1` (整数) | `0` (整数) | tinyint(1) |

❌ **禁止**使用布尔值`true`/`false`或字符串`"on"`/`"off"`

### 6.3 JSON数据传递到Volt模板

❌ **错误方式**（会被HTML实体编码）：
```html
<input type="hidden" value="{{ assignment|json_encode }}">
```

✅ **正确方式**：
```html
<script type="application/json" id="assignment-data">
{{ assignment|json_encode }}
</script>
```

JavaScript获取：
```javascript
var raw = document.getElementById('assignment-data').textContent;
var data = JSON.parse(raw);
```

---

## 7. 发现的问题清单

### 🔴 需要修复的问题

| 文件 | 行号 | 问题描述 | 修复方案 |
|------|-----|---------|---------|
| `app/Http/Admin/Controllers/AssignmentController.php` | 768, 867, 920, 963 | 使用了`total_score`作为返回值key | 改为`max_score` |
| `app/Services/Logic/Assignment/AutoGrade.php` | 115-117 | 单选题correct_answer假设为数组 | 改为字符串比较 |
| `public/static/home/js/assignment.show.js` | 9 | 变量名`deadline`可改为`dueDate`（可选优化） | 本地变量，影响不大 |

### ✅ 已符合规范的部分

- ✅ Models层字段名全部规范
- ✅ Services层大部分代码使用标准字段名
- ✅ JSON字段都通过Getter/Setter方法访问
- ✅ 题目解析逻辑兼容新旧两种格式
- ✅ 状态管理逻辑清晰

---

## 8. 代码修改优先级

### P0 - 必须修复（影响功能）
1. **AutoGrade.php单选题评分逻辑** - 会导致评分错误
2. **AssignmentController.php的total_score** - 虽然只是返回值key，但为了规范统一

### P1 - 建议修复（提升规范性）
1. 统一前端变量命名风格
2. 添加更多错误处理和日志

### P2 - 优化项（性能和体验）
1. 添加必要的数据库索引
2. 优化查询性能
3. 添加缓存策略

---

**文档版本**: v1.0  
**最后更新**: 2025-10-15  
**审查人**: AI Assistant


